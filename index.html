<!DOCTYPE html>
<html lang="en">
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" integrity="sha512-M7nHCiNUOwFt6Us3r8alutZLm9qMt4s9951uo8jqO4UwJ1hziseL6O3ndFyigx6+LREfZqnhHxYjKRJ8ZQ69DQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-scale/1.0.7/d3-scale.min.js" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-color/1.2.1/d3-color.min.js" referrerpolicy="no-referrer"></script>
    <style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			max-width: 100%;
			max-height: 100%;
		}
	    #map {
            width: 100vw;
            height: 100vh;
        }
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            text-align: right;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        .legend {
            text-align: left;
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        #infoChart {
          float: left;
          width: 230px;
          height: 230px;
          transform: translate(-10px,-40px);
          padding-left: 20px;
          padding-right: 20px;
          margin-bottom: -29px;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    <script type="text/javascript" src="us-states.js"></script>
    <script type="text/javascript" src="spiderplot.js"></script>
    <script type="text/javascript">
    let factories = [
        {"name": "Mars Factory",             "lat": 35.19908, "lon": -84.86589},
    ];
    let supplierData = [
        {"name": "International Paper",      "lat": 33.93540, "lon":  -81.09012, "tco": 0.89, "pnr": 0.65, "lca": 0.36, "rar": 0.60},
        {"name": "American Hemp LLC",        "lat": 36.11808, "lon":  -80.31071, "tco": 0.49, "pnr": 0.49, "lca": 0.66, "rar": 0.45},
        {"name": "Boring Hemp Company",      "lat": 45.44651, "lon": -122.27443, "tco": 0.59, "pnr": 0.66, "lca": 0.71, "rar": 0.66},
        {"name": "Delta Hemp Farm",          "lat": 42.74637, "lon": -124.50609, "tco": 0.69, "pnr": 0.81, "lca": 0.73, "rar": 0.90},
        {"name": "CNY Hemp Processing Inc.", "lat": 42.85056, "lon":  -75.85897, "tco": 0.79, "pnr": 0.76, "lca": 0.84, "rar": 0.83},
        {"name": "Seaman Co",                "lat": 42.56507, "lon":  -72.00508, "tco": 0.39, "pnr": 0.70, "lca": 0.52, "rar": 0.44},
    ];
    const scoreColor = d3.scaleLinear()
        .domain([0.00, 1.00])
        .range(["red", "green"])
        .interpolate(d3.interpolateCubehelix.gamma(3));;
    </script>
    <script type="text/javascript">
        const map = L.map('map').setView([37.8, -96], 5);
        function getColor(d) {
            return ['rgba(50,50,50,0.3)', 'rgba(200,200,50,0.6)', 'rgba(150,255,50,0.6)', 'rgba(0,200,0,0.6)'][d];
        }
        function style(state) {
            return {
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7,
                fillColor: getColor(state.properties.leg)
            };
        }
        const pct = d3.format('.0%');
        // Tiles
        const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 8,
            minZoom: 5,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        map.attributionControl.addAttribution('Legislation data &copy; <a href="https://boulderweekly.com/boulderganic/2016-could-be-the-year-for-industrial-hemp/">National Hemp Association</a>');
        // Control that shows info on hover
        const info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        info.update = function (d, e) {
            if (d && d.tco !== undefined) {
                // Show supplier information
                let contents = "<h4>" + d.name + "</h4>TCO: " + pct(d.tco) + "<br />";
                contents += "PNR: " + pct(d.pnr) + "<br />";
                contents += "LCA: " + pct(d.lca) + "<br />";
                contents += "RAR: " + pct(d.rar);
                this._div.innerHTML = contents;
                d3.selectAll('circle')
                    .attr("stroke", "black")
                    .attr("stroke-width", 0.9)
                    .attr("fill-opacity", 0.4);
                d3.select(e)
                    .attr("stroke", "white")
                    .attr("stroke-width", 2)
                    .attr("fill-opacity", 0.9);
            } else {
                // Clear
                this._div.innerHTML = "Select a Supplier to show details";
                d3.selectAll('circle')
                    .attr("stroke", "black")
                    .attr("stroke-width", 0.9)
                    .attr("fill-opacity", 0.4);
            }
        };
        info.addTo(map);
        
        // States
        const states = L.geoJson(statesData, {style}).addTo(map);
        
        // Add factory
        let factory = L.marker([35.199079144133755, -84.86589242977573])
                       .addTo(map)
                       .bindPopup("Factory");
        
        // Add Suppliers
        let svg = d3.select("#map").select("svg");
        svg.attr("pointer-events", "auto")
            .selectAll("myCircles")
            .data(supplierData)
                .join("circle")
                    .attr("cx", d => map.latLngToLayerPoint([d.lat, d.lon]).x)
                    .attr("cy", d => map.latLngToLayerPoint([d.lat, d.lon]).y)
                    .attr("r", 14)
                    .style("fill", d => scoreColor(d.tco))
                    .attr("stroke", "black")
                    .attr("stroke-width", 0.9)
                    .attr("fill-opacity", 0.4);

        // Function that update circle position if something change
        function updateCircles() {
            d3.selectAll("circle")
                .attr("cx", d => map.latLngToLayerPoint([d.lat, d.lon]).x)
                .attr("cy", d => map.latLngToLayerPoint([d.lat, d.lon]).y)
        }
        // If the user change the map (zoom or drag), I update circle position:
        map.on("moveend", updateCircles)
        svg.on("click", handleClick);
        function handleClick (e) {
            if (e.target.tagName === 'circle') {
                let thisData = e.srcElement.__data__;
                info.update(thisData, e.srcElement);
                d3.select('.info').append('svg').attr('id', 'infoChart');
                let spiderData = {"TCO": thisData.tco, "PNR": thisData.pnr, "LCA": thisData.lca, "RAR": thisData.rar};
                let infoColor = d3.scaleSequential().domain([0, 1]).interpolator(d3.interpolateYlGn);
                singleRadar("#infoChart", spiderData, {"width": 230, "height": 230, "color": infoColor, "maxValue": 1});
                //singleSpider("#infoChart", spiderData, {"width": 230, "height": 230, "color": infoColor, "maxValue": 1});
            } else {
                info.update();
                d3.select('#infoChart').remove();
            }
        }
        
        // Legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            const grades = ["No Legislation", "Considering", "Passed", "Growing"];
            div.innerHTML = grades.map((g, i) => '<i style="background:' + getColor(i) + '"></i> ' + g)
                                  .join('<br>');
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>